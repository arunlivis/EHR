var Data = require('../EHR_Json/data.json')

var id;
var table_length;
var INV;
var bill;
var paid;
var write_off;
var a;
var unpaid=[];
var b;
var amount;
var bill_amount=[];
var bill_paid=[];
var Write_Off=[];

module.exports={
    login : function (browser) {
        browser 
        .login(Data.user1[1].username, Data.user1[1].password)

},
'view files' : function (browser){
      browser
       .pause(1000)      
       .useCss()
       .click('a[class="firstLevel"]')
       .pause(500)
       .click('a[href="/EHR/Clinicadmin/view-patient-details-open"]')
       .waitForElementVisible('#col0_filter' , 60000)
       .pause(500)
       .getText('td[class="sorting_1"]' , function(result){
            id=result.value
       })
       .useXpath()
       .pause(200)
       .click("//*[@id='patient']/tbody/tr/td[6]/a/i")
       .useCss()
       .waitForElementVisible('#patient_first_name' , 60000)
       .pause(500)
},
'Billing':function(browser){
  
  browser
      .click('a[onclick="getBillingDetails();"]')
      .waitForElementVisible('button[onclick="addPayment(1);"]' , 60000)
      .pause(500)
      .elements('css selector', 'table#billing tbody tr', function(result) {
        table_length=result.value.length
      })
      

      
},
'Make Payment':function(browser){
  for(i=1; i<=table_length; i++){
        browser
        .useXpath()
           .getText("//*[@id='billing']/tbody/tr["+i+"]/td[5]" , function(result){
                  if(result.value!="Paid"){
                     unpaid.push(1)
                  }
           })
           .getText("//*[@id='billing']/tbody/tr["+i+"]/td[4]" , function(result){
                   bill_amount.push(result.value)
           })
  }
},
'calculation':function(browser){
  browser
        b=unpaid.reduce(function(a, b) { return a + b; }, 0)
 
  if(b==0){
    a=0
  }else{
     a=Math.floor((Math.random()*b)+1)
  }
},
'payment_1':function(browser){
  browser     
      
      if(a!=0){
         browser
      .useCss()
      .click('button[onclick="addPayment(1);"]')
      .waitForElementVisible('#paymentdescription' , 60000 )
      .pause(500)
      .useXpath()
      .getText("//*[@id='savePaymentReceipt']/div[1]/div[1]/div[2]/div[1]/div[2]/table/tbody/tr["+a+"]/td[2]" , function(result){
             INV=result.value.substring(3, 7)
      })
      .getText("//*[@id='savePaymentReceipt']/div[1]/div[1]/div[2]/div[1]/div[2]/table/tbody/tr["+a+"]/td[4]" , function(result){
             bill=result.value
      })
      .getText("//*[@id='savePaymentReceipt']/div[1]/div[1]/div[2]/div[1]/div[2]/table/tbody/tr["+a+"]/td[5]" , function(result){
             paid=result.value
      })
      .getText("//*[@id='savePaymentReceipt']/div[1]/div[1]/div[2]/div[1]/div[2]/table/tbody/tr["+a+"]/td[6]" , function(result){
             write_off=result.value
      })
      .useXpath()
      .pause(1000)
      .click("//*[@id='savePaymentReceipt']/div[2]/button[1]")
      .useCss()
      .waitForElementVisible('button[onclick="addPayment(1);"]' , 60000)
       
    }
    if(a==0){
      INV=0
       browser
      .useCss()
      .click('button[onclick="addPayment(1);"]')
      .waitForElementVisible('#addBillPaymentModal' , 60000)
      .pause(500)
      .useXpath()
      .click("//*[@id='addBillPaymentModal']/div/div/div[1]/button")
      .useCss()
      .waitForElementVisible('button[onclick="addPayment(1);"]' , 60000)
    }
    

},
'pay amount':function(browser){

  for(i=1; i<=table_length;i++){
                browser
                   .useXpath()
                   .pause(1000)
                   if(i<=2){
                    browser
                      .useXpath()
                      .click("//*[@id='billing']/tbody/tr["+i+"]/td[8]/a[1]")
                    }else{
                      browser
                      .useCss()
                      .pause(800)
                      .getLocationInView('#billing_previous')
                      .pause(800)
                      //.useCss()
                      .getLocationInView('#billdate')
                      .pause(500)
                      .useXpath()
                      .click("//*[@id='billing']/tbody/tr["+i+"]/td[8]/a[1]")
                    }
                    browser
                   .useCss()
                   .waitForElementVisible('#btnExportPatientBill' , 60000)
                   .pause(500)
                   .useXpath()
                   .getText("//*[@id='consent-minor-form']/div/div[5]/div[4]/div/div[2]/span" , function(result){
                      bill_paid.push(result.value)
                   })
                   .getText("//*[@id='consent-minor-form']/div/div[6]/div[2]/div/div[2]/span" , function(result){
                      Write_Off.push(result.value)
                   })
                   .pause(500)
                   .useCss()
                   .click('button[onclick="getBillingDetails()"]')
                   .waitForElementVisible('button[onclick="addPayment(1);"]' , 60000)
                   .pause(500)
           }
  browser
  if(INV!=0){
    
    c=Math.floor((Math.random()*3)+1)
        browser
           .useCss()
           .pause(500)
           .click('button[onclick="addPayment(1);"]')
           .waitForElementVisible('#paymentdescription' , 60000 )
           .pause(1000)
           .click('#invoice_'+INV+'')
           .pause(1000)
           .useXpath()
           .verify.containsText("//*[@id='savePaymentReceipt']/div[1]/div[1]/div[2]/div[1]/div[2]/table/tbody/tr["+a+"]/td[4]" , parseInt(paid)+parseInt(write_off))
           .useCss()
           .click('button[onclick="return saveReceipt();"]')
           .pause(500)
           .verify.visible('#payAmount_'+INV+'_Error')
           .verify.visible('#paymentmode_Error')
           amount=Math.floor((Math.random()*parseInt(write_off))+1)
           bill_paid.push(amount)
           browser
           .useCss()
           .pause(500)
           .clearValue('#payAmount_'+INV+'')
           .setValue('#payAmount_'+INV+'' , amount)
           .verify.valueContains('#amountpaid' , amount)
           .pause(500)
           .click('input[name="paymentMode"][value="'+c+'"]')
           .clearValue('#paymentdescription')
           .setValue('#paymentdescription' , 'Reference')
           .pause(500)
           .click('button[onclick="return saveReceipt();"]')
           .waitForElementVisible('button[onclick="addPayment(1);"]' , 60000)
           .pause(500)

         }
         
},
'Accounts Receivable':function(browser){
 

  browser
     .pause(500)
     .click('a[href="/EHR/Clinicadmin/viewAccountReceivableDetails"]')
     .waitForElementVisible('#fileType' , 60000)
     .pause(500)
     .click('input[name="filesType"][value="1"]')
     .waitForElementVisible('#accountreceviable_paginate' , 60000 , function(result){
      browser
     .pause(500)
     .clearValue('input[id="Patient ID"][class="column_filter"]')
     .setValue('input[id="Patient ID"][class="column_filter"]' , id)
            check_bill=(bill_amount.map(Number)).reduce(function(a, b) { return a + b; }, 0)
            check_paid=(bill_paid.map(Number)).reduce(function(a, b) { return a + b; }, 0)
            check_Write=(Write_Off.map(Number)).reduce(function(a, b) { return a + b; }, 0)
             if(INV!=0){
              check_Write=Math.abs(check_Write-amount)
            }
            browser
              .useXpath()
              .waitForElementVisible("//*[@id='accountreceviable']/tbody/tr/td[6]" , 60000)
              .pause(2000)
              .verify.containsText("//*[@id='accountreceviable']/tbody/tr/td[6]" , check_bill)
              .verify.containsText("//*[@id='accountreceviable']/tbody/tr/td[8]" , check_paid)
              .verify.containsText("//*[@id='accountreceviable']/tbody/tr/td[10]" , check_Write)
})
},
'Open & Close Patient':function(browser){
     browser
     .useCss()
     .pause(1000)
     .click('a[onclick="closePatientFile('+id+',0)"]')
     .waitForElementVisible('#closemodal' , 60000)
     .pause(500)
     .click('button[onclick="closeFile()"]')
     .pause(1000)
     .click('a[href="/EHR/Clinicadmin/viewAccountReceivableDetails"]')
     .waitForElementVisible('#fileType' , 60000)
     .pause(500)
     .click('input[name="filesType"][value="0"]')
     .waitForElementVisible('input[id="Patient ID"][class="column_filter"]' , 60000)
     .pause(1500)
     .clearValue('input[id="Patient ID"][class="column_filter"]')
     .pause(500)
     .setValue('input[id="Patient ID"][class="column_filter"]' , id)
     .pause(1000)
     .useXpath()
     .waitForElementVisible("//*[@id='accountreceviable']/tbody/tr/td[1]" , 60000)
     .pause(2500)
     .verify.containsText("//*[@id='accountreceviable']/tbody/tr/td[1]" , id)
     .pause(500)
     .useCss()
     .click('a[onclick="closePatientFile('+id+',1)"]')
     .waitForElementVisible('#closemodal' , 60000)
     .pause(500)
     .click('button[onclick="closeFile()"]')
     .pause(1000)
     .click('a[href="/EHR/Clinicadmin/viewAccountReceivableDetails"]')
     .waitForElementVisible('#fileType' , 60000)
     .pause(500)
     .click('input[name="filesType"][value="1"]')
     .waitForElementVisible('#accountreceviable_paginate' , 60000)
     .pause(1000)
     .clearValue('input[id="Patient ID"][class="column_filter"]')
     .setValue('input[id="Patient ID"][class="column_filter"]' , id)
     .pause(1000)
     .useXpath()
     .waitForElementVisible("//*[@id='accountreceviable']/tbody/tr[1]/td[1]" , 60000)
     .pause(2500)
     .verify.containsText("//*[@id='accountreceviable']/tbody/tr[1]/td[1]" , id)
     .pause(500)
     .end()

     }
}